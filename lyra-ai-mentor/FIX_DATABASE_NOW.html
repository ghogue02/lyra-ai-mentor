<!DOCTYPE html>
<html>
<head>
    <title>Fix Toolkit Database</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #e11d48; }
        .sql-box {
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .copy-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .copy-btn:hover { background: #2563eb; }
        .copy-btn:active { transform: scale(0.98); }
        .success { color: #10b981; display: none; }
        .step {
            background: #eff6ff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #3b82f6;
        }
        a { color: #3b82f6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸš¨ Fix Toolkit Database Tables</h1>
        
        <div class="step">
            <strong>Step 1:</strong> Click the button below to copy the SQL fix
        </div>
        
        <button class="copy-btn" onclick="copySQL()">ðŸ“‹ Copy SQL Fix</button>
        <span class="success" id="copySuccess">âœ“ Copied to clipboard!</span>
        
        <div class="sql-box" id="sqlContent">-- Generated by MCP Database Fix System
-- Timestamp: 2025-07-09T13:10:18.855Z

-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Drop existing tables if they exist (clean slate)
DROP TABLE IF EXISTS public.user_toolkit_achievements CASCADE;
DROP TABLE IF EXISTS public.user_toolkit_unlocks CASCADE;
DROP TABLE IF EXISTS public.toolkit_items CASCADE;
DROP TABLE IF EXISTS public.toolkit_achievements CASCADE;
DROP TABLE IF EXISTS public.toolkit_categories CASCADE;

-- Create toolkit_categories table
CREATE TABLE public.toolkit_categories (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    category_key TEXT UNIQUE NOT NULL,
    name TEXT NOT NULL,
    description TEXT NOT NULL,
    icon TEXT NOT NULL,
    gradient TEXT NOT NULL,
    order_index INTEGER NOT NULL DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Create toolkit_items table with metadata support
CREATE TABLE public.toolkit_items (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name TEXT NOT NULL,
    category_id UUID NOT NULL REFERENCES public.toolkit_categories(id) ON DELETE CASCADE,
    description TEXT,
    preview_url TEXT,
    download_url TEXT,
    file_size INTEGER,
    file_type TEXT,
    is_new BOOLEAN DEFAULT FALSE,
    is_featured BOOLEAN DEFAULT FALSE,
    is_premium BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    required_level INTEGER DEFAULT 1,
    required_achievements TEXT[] DEFAULT '{}',
    download_count INTEGER DEFAULT 0,
    unlock_count INTEGER DEFAULT 0,
    rating_sum NUMERIC DEFAULT 0,
    rating_count INTEGER DEFAULT 0,
    average_rating NUMERIC GENERATED ALWAYS AS (
        CASE 
            WHEN rating_count &gt; 0 THEN rating_sum / rating_count 
            ELSE 0 
        END
    ) STORED,
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UNIQUE(category_id, name)
);

-- Create user_toolkit_unlocks table
CREATE TABLE public.user_toolkit_unlocks (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    toolkit_item_id UUID NOT NULL REFERENCES public.toolkit_items(id) ON DELETE CASCADE,
    unlocked_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    download_count INTEGER DEFAULT 0,
    last_downloaded_at TIMESTAMPTZ,
    rating INTEGER CHECK (rating &gt;= 1 AND rating &lt;= 5),
    rated_at TIMESTAMPTZ,
    user_notes TEXT,
    UNIQUE(user_id, toolkit_item_id)
);

-- Create toolkit_achievements table
CREATE TABLE public.toolkit_achievements (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    achievement_key TEXT UNIQUE NOT NULL,
    name TEXT NOT NULL,
    description TEXT NOT NULL,
    icon TEXT NOT NULL,
    color TEXT NOT NULL,
    criteria_type TEXT NOT NULL CHECK (criteria_type IN (
        'unlock_count', 'category_count', 'category_complete',
        'download_count', 'rating_count', 'streak_days', 'special'
    )),
    criteria_value INTEGER,
    criteria_metadata JSONB DEFAULT '{}',
    order_index INTEGER DEFAULT 0,
    achievement_tier TEXT CHECK (achievement_tier IN ('bronze', 'silver', 'gold', 'platinum')) DEFAULT 'bronze',
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Create user_toolkit_achievements table
CREATE TABLE public.user_toolkit_achievements (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    achievement_id UUID NOT NULL REFERENCES public.toolkit_achievements(id) ON DELETE CASCADE,
    current_value INTEGER DEFAULT 0,
    target_value INTEGER,
    is_unlocked BOOLEAN DEFAULT FALSE,
    unlocked_at TIMESTAMPTZ,
    notification_shown BOOLEAN DEFAULT FALSE,
    UNIQUE(user_id, achievement_id)
);

-- Create indexes
CREATE INDEX idx_toolkit_items_category ON public.toolkit_items(category_id);
CREATE INDEX idx_toolkit_items_active ON public.toolkit_items(is_active) WHERE is_active = TRUE;
CREATE INDEX idx_user_toolkit_unlocks_user ON public.user_toolkit_unlocks(user_id);
CREATE INDEX idx_user_toolkit_unlocks_item ON public.user_toolkit_unlocks(toolkit_item_id);

-- Enable RLS
ALTER TABLE public.toolkit_categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.toolkit_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_toolkit_unlocks ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.toolkit_achievements ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_toolkit_achievements ENABLE ROW LEVEL SECURITY;

-- RLS Policies
CREATE POLICY "Anyone can view active categories"
    ON public.toolkit_categories FOR SELECT
    USING (is_active = TRUE);

CREATE POLICY "Anyone can view active toolkit items"
    ON public.toolkit_items FOR SELECT
    USING (is_active = TRUE);

CREATE POLICY "Users can view own unlocks"
    ON public.user_toolkit_unlocks FOR SELECT
    USING (auth.uid() = user_id);

CREATE POLICY "Users can create own unlocks"
    ON public.user_toolkit_unlocks FOR INSERT
    WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own unlocks"
    ON public.user_toolkit_unlocks FOR UPDATE
    USING (auth.uid() = user_id);

CREATE POLICY "Anyone can view achievements"
    ON public.toolkit_achievements FOR SELECT
    USING (TRUE);

CREATE POLICY "Users can view own achievement progress"
    ON public.user_toolkit_achievements FOR SELECT
    USING (auth.uid() = user_id);

-- Insert categories
INSERT INTO public.toolkit_categories (category_key, name, description, icon, gradient, order_index) VALUES
    ('email', 'Email Templates', 'Professional email templates for every occasion', 'Mail', 'from-blue-500 to-cyan-500', 1),
    ('grants', 'Grant Proposals', 'Winning grant proposal templates and guides', 'FileText', 'from-purple-500 to-pink-500', 2),
    ('data', 'Data Visualizations', 'Interactive charts and data presentation tools', 'BarChart3', 'from-green-500 to-emerald-500', 3),
    ('automation', 'Automation Workflows', 'Time-saving automation templates', 'Workflow', 'from-orange-500 to-red-500', 4),
    ('change', 'Change Management', 'Tools for managing organizational change', 'Users', 'from-indigo-500 to-purple-500', 5),
    ('social', 'Social Media Content', 'Engaging social media templates', 'Share2', 'from-pink-500 to-rose-500', 6),
    ('training', 'Training Materials', 'Educational resources and training templates', 'BookOpen', 'from-teal-500 to-cyan-500', 7),
    ('reports', 'Reports & Presentations', 'Professional report and presentation templates', 'Presentation', 'from-amber-500 to-orange-500', 8);

-- Insert achievements
INSERT INTO public.toolkit_achievements (achievement_key, name, description, icon, color, criteria_type, criteria_value, order_index, achievement_tier) VALUES
    ('first_unlock', 'First Tool Unlocked', 'Downloaded your first tool', 'Star', 'text-yellow-500', 'unlock_count', 1, 1, 'bronze'),
    ('category_explorer', 'Category Explorer', 'Unlock tools from 3 different categories', 'Grid3X3', 'text-blue-500', 'category_count', 3, 2, 'silver'),
    ('power_user', 'Power User', 'Unlock 10 tools', 'Zap', 'text-purple-500', 'unlock_count', 10, 3, 'gold');

-- Add sample PACE email item
INSERT INTO public.toolkit_items (name, category_id, description, file_type, is_new, is_active, metadata) 
SELECT 
    'PACE Email Template',
    id,
    'Professional email template using the PACE framework',
    'pace_email',
    true,
    true,
    '{"framework": "PACE", "version": "1.0"}'::jsonb
FROM public.toolkit_categories 
WHERE category_key = 'email';

-- Grant permissions
GRANT USAGE ON SCHEMA public TO anon, authenticated;
GRANT ALL ON ALL TABLES IN SCHEMA public TO anon, authenticated;
GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO anon, authenticated;

-- Final verification query
SELECT 
    'Toolkit setup complete!' as message,
    COUNT(DISTINCT tc.id) as categories_count,
    COUNT(DISTINCT ti.id) as items_count,
    COUNT(DISTINCT ta.id) as achievements_count
FROM public.toolkit_categories tc
LEFT JOIN public.toolkit_items ti ON tc.id = ti.category_id
CROSS JOIN public.toolkit_achievements ta;
</div>
        
        <div class="step">
            <strong>Step 2:</strong> Open your <a href="https://hfkzwjnlxrwynactcmpe.supabase.com/sql" target="_blank">Supabase SQL Editor</a>
        </div>
        
        <div class="step">
            <strong>Step 3:</strong> Paste the SQL and click "Run"
        </div>
        
        <div class="step">
            <strong>Step 4:</strong> Verify the fix worked by checking your app
        </div>
        
        <hr style="margin: 30px 0;">
        
        <p><strong>What this fixes:</strong> Missing toolkit_categories table and related tables that are causing 404 errors in your application.</p>
    </div>
    
    <script>
        function copySQL() {
            const sql = document.getElementById('sqlContent').textContent;
            navigator.clipboard.writeText(sql).then(() => {
                document.getElementById('copySuccess').style.display = 'inline';
                setTimeout(() => {
                    document.getElementById('copySuccess').style.display = 'none';
                }, 3000);
            }).catch(err => {
                alert('Failed to copy. Please select and copy manually.');
            });
        }
    </script>
</body>
</html>